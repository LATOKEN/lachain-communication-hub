sudo: required

jobs:
  include:
    - stage: Build
      os: linux
      language: go
      go: 1.17.3
      script:
        - go get -d -v ./...
        - go build -o lib/linux-x64/libhub.so -buildmode=c-shared embedded_hub.go
      workspaces:
        create:
          name: bin_linux
          paths: 
            - lib/linux-x64

    - stage: Build
      os: osx
      language: go
      go: 1.17.3
      script:
        - go get -d -v ./...
        - go build -o lib/osx-x64/libhub.dylib -buildmode=c-shared embedded_hub.go
      workspaces:
        create:
          name: bin_osx
          paths: 
            - lib/osx-x64
    
    - stage: Build
      os: windows
      language: go
      go: 1.17.3
      script:
        - go get -d -v ./...
        - go build -o lib/win-x64/libhub.dll -buildmode=c-shared embedded_hub.go
      workspaces:
        create:
          name: bin_win
          paths: 
            - lib/win-x64

    - stage: Nuget_build
      language: csharp
      dotnet: 5.0
      mono: none
      dist: focal
      addons:
        apt:
          packages:
            - dotnet-sdk-3.1
            - nuget
      workspaces: 
        use:
          - bin_linux
          - bin_osx
          - bin_win
      env:
        global:
          - DOTNET_SKIP_FIRST_TIME_EXPERIENCE=true
          - DOTNET_CLI_TELEMETRY_OPTOUT=1
      install:
        - dotnet restore Lachain.CommunicationHub.Net
        - dotnet build -c Release Lachain.CommunicationHub.Net
      script:
        - tar -xvf ${TRAVIS_HOME}/.casher/bin_osx-fetch.tgz
        - mv Users/travis/gopath/src/github.com/LATOKEN/lachain-communication-hub/lib .
        - mv C:/Users/travis/gopath/src/github.com/LATOKEN/lachain-communication-hub/lib/win-x64 lib
        - mv lib/win-x64/libhub.dll lib/win-x64/hub.dll
        - mv /home/travis/gopath/src/github.com/LATOKEN/lachain-communication-hub/lib/linux-x64 lib
        - nuget pack Lachain.CommunicationHub.Native.nuspec
        - cd Lachain.CommunicationHub.Net/
        - dotnet build Lachain.CommunicationHub.Net.sln
        - dotnet pack Lachain.CommunicationHub.Net.csproj

      deploy:
        provider: releases
        api_key:
          secure: "bV8Ts11g4eaVySzhzuOuMhg3mwWvKazI0DP2FGBaMiAJTtVGM6pUIPt+JnKUtw5syZTJvpBZu5j9pDV5Ckwlzpx836jFRfjYDrigPvnazJw2CUAEeBPtVBSLuiFnZn3/Whb+p6U/PygxZYFoQaEn0MPHcJy83s52cMGeqI1u22v9b1mpFcdoxU6EI4lfGweZ/aexmhaG7A9QKMq/Ux3T1Um+aqxWswYZuHwQCGYHp+ezSfUmhY4yiCcvXyN9Cla6CMKx1xYKCmODVFVvQRB4mbuYM9xCJw7oX5L2yeykE6FsmFMswRyjC1IF+3RzCT+VjJq5kUlwrbJyAjSsukvcllX0g6YLA2eW1A2Ju/SLRyDUWRMqwJJU/ygRNHEPt53+1iOt0LooGELyl76jXCBAczTgZpdPWN3MLR4OWGgPtV6qMnakvcYX5gSuq7lE/1W1B5rhym/SG8yPX9WMLOocxpoJbetW/6ENJECbWxtCD/QIZ8pqFr9GfDRksTMXFNVNuSrMTAp4Ns5xguMydqQ53CPFCXzdJEqMxY1x9gBN5ubPfoGElz6vbSpxoWYLPxGhLY8s7/BIsm0WI8B/Blzehmriz4tJQVzp9cOSzZOw7SdCLM2gZGpLuZNSPsxU5IUeem5zqHuPv1SNTVRAuiyZFWQQ5K3tNsfNgizvXcwujxI="
        file_glob: true
        file: 
          - Lachain.CommunicationHub.NativeLib*nupkg
          - bin/Debug/Lachain.CommunicationHub.Net*.nupkg
        skip_cleanup: true
        draft: true
        on:
          tags: true